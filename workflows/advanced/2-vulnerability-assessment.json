{
    "name": "Level 2 - Advanced Vulnerability Assessment",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [{"field": "days", "expression": "1"}]
                }
            },
            "name": "Daily Scan",
            "type": "n8n-nodes-base.scheduleTrigger"
        },
        {
            "parameters": {
                "url": "http://elasticsearch:9200/devices/_search",
                "method": "GET"
            },
            "name": "Get Active Devices",
            "type": "n8n-nodes-base.httpRequest"
        },
        {
            "parameters": {
                "functionCode": "for (const device of $input.all()) {\n  const ip = device.json.ip;\n  await $exec(`nmap -sV -sC --script vuln ${ip} -oX /tmp/vuln_${ip}.xml`);\n}"
            },
            "name": "Scan Each Device",
            "type": "n8n-nodes-base.function"
        },
        {
            "parameters": {
                "functionCode": "const results = [];\nfor (const file of await $list('/tmp/vuln_*.xml')) {\n  const content = await $read(file);\n  results.push(parseVulnResults(content));\n}\nreturn {json: {vulnerabilities: results}};"
            },
            "name": "Process Results",
            "type": "n8n-nodes-base.function"
        },
        {
            "parameters": {
                "url": "http://elasticsearch:9200/vulnerabilities/_bulk",
                "method": "POST",
                "sendBody": true,
                "bodyParameters": {
                    "results": "={{$json.vulnerabilities}}"
                }
            },
            "name": "Store Results",
            "type": "n8n-nodes-base.httpRequest"
        }
    ]
}
